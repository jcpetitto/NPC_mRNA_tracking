Bootstrap: docker
From: nvidia/cuda:11.8.0-cudnn8-devel-ubuntu20.04

%environment
    export CONDA_DIR=/opt/conda
    export PATH=$CONDA_DIR/bin:$PATH
    export CUDA_HOME=/usr/local/cuda-11.8

%post
    # Install OpenBLAS
    # yum makecache
    # yum -y install openblas-static
    apt-get update && apt-get install -y --no-install-recommends \
        libopenblas-dev \
        wget \
        git \
        ca-certificates

    # Install CMake
    wget --quiet https://github.com/Kitware/CMake/releases/download/v3.28.0/cmake-3.28.0-linux-x86_64.sh -O ~/cmake3.28.sh
    mkdir /opt/cmake3.28
    bash ~/cmake3.28.sh --prefix=/opt/cmake3.28 --skip-license

    # Clone and build baspacho
    git clone https://github.com/facebookresearch/baspacho.git
    cd baspacho
    /opt/cmake3.28/bin/cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DBLA_STATIC=ON \
        -DCMAKE_CUDA_COMPILER=/usr/local/cuda-11.8/bin/nvcc \
        -DBASPACHO_CUDA_ARCHS="60;70;75;80" \
        -DBUILD_SHARED_LIBS=OFF \
        -DBASPACHO_BUILD_TESTS=OFF -DBASPACHO_BUILD_EXAMPLES=OFF
    /opt/cmake3.28/bin/cmake --build build -- -j16
    cd ..

    # Install Miniconda
    wget --quiet https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O ~/miniconda.sh
    bash ~/miniconda.sh -b -p /opt/conda
    . /opt/conda/etc/profile.d/conda.sh
    conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/main
    conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/r
    # conda create --name yeast_theseus python=3.10 -y
    # conda activate yeast_theseus
    # export PATH=/opt/conda/envs/yeast_theseus/bin:$PATH

    # Create conda environment from .yml
cat << EOF > environment.yml
    channels:
    - pytorch
    - nvidia  # <-- Make sure this is here
    - conda-forge
    - https://repo.anaconda.com/pkgs/main
    - https://repo.anaconda.com/pkgs/r
    dependencies:
    # --- Core Python & CUDA ---
    - python=3.10
    - pytorch=2.5.1
    - torchvision=0.20.1
    - pytorch-cuda=11.8
    
    # --- Core Dependencies for Theseus & User Code ---
    - suitesparse=7.10.1
    - scikit-image
    - scikit-sparse
    - matplotlib
    - pandas
    - numpy
    - scipy
    - tifffile
    - tqdm
    - pyyaml
    - lxml
    - pillow
    - jupyter

    # --- Pip Packages ---
    - pip:
        - aiohappyeyeballs==2.6.1
        - aiohttp==3.13.0
        - aiosignal==1.4.0
        - attrs==25.4.0
        - frozenlist==1.8.0
        - hf-xet==1.1.10
        - huggingface-hub==0.35.3
        - iniconfig==2.1.0
        - lightning-utilities==0.15.2
        - multidict==6.7.0
        - pluggy==1.6.0
        - propcache==0.3.2
        - pygments==2.19.2
        - pytest==8.4.2
        - pytorch-lightning==2.5.5
        - safetensors==0.6.2
        - segmentation-models-pytorch==0.5.0
        - semantic-version==2.10.0
        - timm==1.0.20
        - torchkin==0.1.1
        - torchlie==0.1.0
        - torchmetrics==1.8.2
        - urdf-parser-py==0.0.4
        - yarl==1.22.0
EOF

conda env create -f environment.yml -n yeast_theseus -y

conda activate yeast_theseus

# Clone and prepare Theseus
git clone https://github.com/facebookresearch/theseus.git
cd theseus
git fetch --all --tags
git checkout 0.2.2 -b tmp_build
git log -n 1
export BASPACHO_ROOT_DIR=/baspacho
export ENABLE_CUDA=1
# pip install -e .
pip install .

# install imreg_dft from source
pip install --no-deps git+https://github.com/matejak/imreg_dft.git

# Set up /.singularity_bash for conda activation
echo ". /opt/conda/etc/profile.d/conda.sh" >> $SINGULARITY_ENVIRONMENT
echo "conda activate yeast_theseus" >> $SINGULARITY_ENVIRONMENT
