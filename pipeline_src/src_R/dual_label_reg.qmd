---
title: "Dual Label: Registration (Draft)"
format:
    html:
        # html-table-processing: none
        embed-resources: true
        code-fold: true
        # code-tools: true
        code-overflow: wrap
execute:
    enabled: true
    cache: true
knitr:
    opts_chunk:
        message: false
---

```{css}
#| label: css-definitions
#| include: false

figure.quarto-float-tbl figcaption.quarto-float-caption-top{
    text-align: left !important;
}

caption, .table-caption {
    text-align: left !important;
}

figcaption {
  text-align: left !important;
}

.summary-table {
    font-size: 12px;        
    border: 1px solid #ddd;
    margin-bottom: 20px; 
}

.summary-table th {
    background-color: #f2f2f2 !important;
    font-weight: bold;
    text-align: center;
}

.scrollable-cell {
  height: 100px;         /* Set a fixed height for the cell */
  width: 200px;          /* Set a fixed width */
  overflow-y: auto;      /* Add a vertical scrollbar if content overflows */
  display: block;        /* Necessary for height to work correctly */
}

.highlighter{
    background-color:yellow;
}
```

```{r}
#| label: library-imports
#| include: false
library(jsonlite)
library(tidyverse)
library(tidyr)
library(knitr)
library(glue)
# library(cowplot)
library(kableExtra)
library(patchwork)
```

```{r}
#| label: knitr-options
#| include: false
options(knitr.kable.NA='')
```

```{r}
#| label: directory-paths
#| include: false
src_r_dir <- "/Users/jctourtellotte/UMass Medical School Dropbox/Jocelyn Tourtellotte/11_Grunwald_Shared_Projects_Folder/Lab_Jocelyn/07_Yeast/src_yeast_pipeline/src_R/"
dual_label_path <- "/Users/jctourtellotte/UMass Medical School Dropbox/Jocelyn Tourtellotte/11_Grunwald_Shared_Projects_Folder/Lab_Jocelyn/07_Yeast/yeast_output/dual_label_experiments/"
no_merge_reg_subdir <- "no_merge/registration/"
merged_reg_subdir <- "merged/registration/"
```

```{r}
#| label: sourcing scripts
#| include: false
# TODO: put file location root in a config
source('./src_R/r_utility_fns.R')
source('./src_R/experiment_key.R')
```

```{r}
#| label: set-globals
#| include: false
PIXEL_TO_NM <- 128
strains_to_include <- c("BMY1408", "BMY1409", "BMY1410")

table_num <- 1
```

```{r}
#| label: import-experiment-key
#| include: false
all_experiment_key <- read_csv(paste0(dual_label_path, "dual_label_exper_table.csv")) %>% dplyr::filter(strain %in% strains_to_include)
all_experiment_key_n <- all_experiment_key %>% group_by(strain, date, addl_info) %>% summarise(FoV_count = n()) %>% ungroup()

all_experiment_key <- left_join(all_experiment_key, all_experiment_key_n) %>% relocate(FoV_count, .after = addl_info)
```

```{r}
#| label: tbl-experiment-key
#| echo: false
nested_key <- all_experiment_key %>%
    nest(FoV_id = FoV_id)
nested_key %>% kbl() %>%
    kable_styling(bootstrap_options = c("striped", "condensed"))
```

```{r}
#| label: var-definitions
#| echo: false
def_df <- tibble(
    word_var = c("Strain", "Experiment", "Segmentation Method", "Mode", "Granularity"),
    desc_var = c("<ul><li>BMY1408</li><li>BMY1409</li><li>BMY1410</li></ul>",
    "<div style=\"padding-left: 30px;\">Some strains were imaged on multiple days or in multiple batches on a single day. Each unique strain/day/batch combination constitutes an `experiment`.</div>",
    "<ul><li>longest segment</li><li>merged segments</li></ul>",
    "<ul><li>1 (Brightfield before fluorescence microscopy)</li><li>2 (Brightfield after fluorescence microscopy)</li></ul>",
    "<ul><li>Whole FoV</li><li>merged segments</li><li>\" \" subset into 25 frame slices, calculates the registration vector per frame range for each slice with respect to the mean channel 1 image and the mean channel 2 image for the slice</li></ul>")    
)

    kbl(x = def_df, escape = FALSE, col.names = NULL) %>%
    kable_styling(bootstrap_options = c("bordered", "condensed"))
```

On the HPC: registration data stored in 1 JSON per each of `{r} dplyr::n_distinct(all_experiment_key)` experiment (nested) are aggregated by mode and segmentation method, then exported into a 3 CSV files total (flat files), 1 per level of granularity.

# Registration

```{r}
#| label: import-reg-data
load_reg_csv <- function(path, strains_to_include, experiment_key_df){
    reg_join_by <- join_by(strain, FoV_id)
    new_df <- read_csv(path) %>%
                dplyr::filter(strain %in% strains_to_include) %>%
                select(!addl_info) 
    new_df <- left_join(experiment_key_df, new_df, by = reg_join_by, relationship = "many-to-many")
    return(new_df)
}
# import CSVs derived from JSONs via R on the HPC
longest_seg_FoV_reg <- load_reg_csv(paste0(dual_label_path, no_merge_reg_subdir, "longest_seg_FoV_reg_dual_label.csv"), strains_to_include, all_experiment_key)
longest_seg_ne_label_reg <- load_reg_csv(paste0(dual_label_path, no_merge_reg_subdir, "longest_seg_ne_label_reg_dual_label.csv"), strains_to_include, all_experiment_key)

longest_seg_ne_label_reg %>% group_by(strain, date, addl_info, FoV_id) %>% summarise(ne_count = n())

longest_seg_slice_reg <- load_reg_csv(paste0(dual_label_path, no_merge_reg_subdir, "longest_seg_ne_slice_reg_dual_label.csv"), strains_to_include, all_experiment_key)

merged_seg_FoV_reg <- load_reg_csv(paste0(dual_label_path, merged_reg_subdir, "merged_FoV_reg_dual_label.csv"), strains_to_include, all_experiment_key) 
merged_seg_ne_label_reg <- load_reg_csv(paste0(dual_label_path, merged_reg_subdir, "merged_ne_label_reg_dual_label.csv"), strains_to_include, all_experiment_key)
merged_seg_slice_reg <- load_reg_csv(paste0(dual_label_path, merged_reg_subdir, "merged_ne_slice_reg_dual_label.csv"), strains_to_include, all_experiment_key)
```

## Summary statistics

### Group by $experiment \times mode$

```{r}
#| label: summ-stats-reg-exper
longest_seg_exper_mode_reg_summ <- longest_seg_FoV_reg %>%
    group_by(strain, date, mode, addl_info) %>%
    calc_summ_stats(col_to_summ = c(scale, angle, shift_x, shift_y)) %>%
    ungroup()
    # mutate(across(
    #     .cols = ends_with("_sd"),
    #     .fns = ~ 3.49 * .x * n**(-1/3),
    #     .names = "{str_remove(.col, '_sd')}_est_bin_width"))

merged_seg_exper_mode_reg_summ <- merged_seg_FoV_reg %>%
    group_by(strain, date, mode, addl_info) %>%
    calc_summ_stats(col_to_summ = c(scale, angle, shift_x, shift_y)) %>%
    ungroup()
        # mutate(across(
        # .cols = ends_with("_sd"),
        # .fns = ~ 3.49 * .x * n**(-1/3),
        # .names = "{str_remove(.col, '_sd')}_est_bin_width"))
```

Scott's Rule[@scott1979]: bin-width estimation: $3.49σn^{−1/3}$

Histogram Count = Density \* N \* Bin Width

#### Scale

::::: {layout-ncol="2"}
::: column
```{r}
#| label: fig-scale-lgt-seg-by-exper
#| fig-cap: "Scale distribution stratified by experiment and mode."
longest_seg_FoV_reg_to_plot <- left_join(longest_seg_FoV_reg, longest_seg_exper_mode_reg_summ,
                                            by = c("strain", "date", "mode", "addl_info")) %>%
                                mutate(exper = paste(strain, date, sep = ", "))

print(create_histogram_plot_grid(longest_seg_FoV_reg_to_plot, "scale", c("exper", "mode"), x_limit_method = "minmax", num_cols = 2))                                
```
:::

::: column
```{r}
#| label: tbl-scale-lgt-seg-by-exper
#| tbl-cap: "Summary statistics for scale stratified by experiment and mode."
longest_seg_exper_mode_reg_summ %>% select(strain:n, starts_with("scale")) %>%
    kbl(table.attr = "class=\'summary-table\'", booktabs = TRUE) %>%
    kable_paper("hover", fixed_thead = T) %>%
    kable_styling(full_width = FALSE)
```
:::
:::::

::::: {layout-ncol="2"}
::: column
```{r}
#| label: fig-scale-mrg-seg-by-exper
merged_seg_FoV_reg_to_plot <- left_join(merged_seg_FoV_reg, merged_seg_exper_mode_reg_summ,
                                            by = c("strain", "date", "mode", "addl_info")) %>%
                                mutate(exper = paste(strain, date, sep = ", "))

create_histogram_plot_grid(merged_seg_FoV_reg_to_plot, "scale", c("exper", "mode"), x_limit_method = "minmax", num_cols = 2)
```
:::

::: column
```{r}
#| label: tbl-scale-mgr-seg-by-exper
#| #| tbl-cap: "Summary statistics for scale stratified by experiment and mode."
merged_seg_exper_mode_reg_summ %>% select(strain:n, starts_with("scale")) %>%
    kbl(table.attr = "class=\'summary-table\'", booktabs = TRUE) %>%
    kable_paper("hover", fixed_thead = T) %>%
    kable_styling(full_width = FALSE)
```
:::
:::::

Plotting only those data points with $\bar{x}\pm2\sigma$

```{r}
#| label: fig-scale-lgt-seg-by-exper-2sig
create_histogram_plot_grid(dplyr::filter(longest_seg_FoV_reg_to_plot, between(scale, -2*scale_sd + scale_mean, scale_mean + 2*scale_sd)), "scale", c("exper", "mode"), x_limit_method = "minmax", num_cols = 2)
```

```{r}
#| label: fig-scale-mrg-seg-by-exper-2sig
create_histogram_plot_grid(dplyr::filter(merged_seg_FoV_reg_to_plot, between(scale, -2*scale_sd + scale_mean, scale_mean + 2*scale_sd)), "scale", c("exper", "mode"), x_limit_method = "minmax", num_cols = 2)
```

#### Angle

::::: {layout-ncol="2"}
::: column
```{r}
#| label: fig-angle-lgt-seg-by-exper
longest_seg_FoV_reg_to_plot <- left_join(longest_seg_FoV_reg, longest_seg_exper_mode_reg_summ,
                                            by = c("strain", "date", "mode", "addl_info")) %>%
                                mutate(exper = paste(strain, date, sep = ", ")) %>%
                                dplyr::filter(strain %in% strains_to_include)

print(create_histogram_plot_grid(longest_seg_FoV_reg_to_plot, "angle", c("exper", "mode"), x_limit_method = "minmax", num_cols = 2))
```
:::

::: column
```{r}
#| label: tbl-angle-lgt-seg-by-exper
longest_seg_exper_mode_reg_summ %>% select(strain:n, starts_with("angle")) %>%
    kbl(table.attr = "class=\'summary-table\'", booktabs = TRUE) %>%
    kable_paper("hover", fixed_thead = T) %>%
    kable_styling(full_width = FALSE)
```
:::
:::::

::::: {layout-ncol="2"}
::: column
```{r}
#| label: fig-angle-mrg-seg-by-exper
merged_seg_FoV_reg_to_plot <- left_join(merged_seg_FoV_reg, merged_seg_exper_mode_reg_summ,
                                            by = c("strain", "date", "mode", "addl_info")) %>%
                                mutate(exper = paste(strain, date, sep = ", ")) %>%
                                dplyr::filter(strain %in% strains_to_include)

print(create_histogram_plot_grid(merged_seg_FoV_reg_to_plot, "angle", c("exper", "mode"), x_limit_method = "minmax", num_cols = 2))
```
:::

::: column
```{r}
#| label: tbl-angle-mgr-seg-by-exper
merged_seg_exper_mode_reg_summ %>% select(strain:n, starts_with("angle")) %>%
    kbl(table.attr = "class=\'summary-table\'", booktabs = TRUE) %>%
    kable_paper("hover", fixed_thead = T) %>%
    kable_styling(full_width = FALSE)
```
:::
:::::

Plotting only those data points with $\bar{x}\pm2\sigma$

```{r}
#| label: fig-angle-lgt-seg-by-exper-2sig
create_histogram_plot_grid(dplyr::filter(longest_seg_FoV_reg_to_plot, between(angle, -2*angle_sd + angle_mean, angle_mean + 2*angle_sd)), "angle", c("exper", "mode"), x_limit_method = "minmax", num_cols = 2)
```

```{r}
create_histogram_plot_grid(dplyr::filter(merged_seg_FoV_reg_to_plot, between(angle, -2*angle_sd + angle_mean, angle_mean + 2*angle_sd)), "angle", c("exper", "mode"), x_limit_method = "minmax", num_cols = 2)
```

#### Shift X

::::: {layout-ncol="2"}
::: column
```{r}
#| label: fig-shift_x-lgt-seg-by-exper
longest_seg_FoV_reg_to_plot <- left_join(longest_seg_FoV_reg, longest_seg_exper_mode_reg_summ,
                                            by = c("strain", "date", "mode", "addl_info")) %>%
                                mutate(exper = paste(strain, date, sep = ", ")) %>%
                                dplyr::filter(strain %in% strains_to_include)

print(create_histogram_plot_grid(longest_seg_FoV_reg_to_plot, "shift_x", c("exper", "mode"), x_limit_method = "minmax", num_cols = 2))
```
:::

::: column
```{r}
#| label: tbl-shift_x-lgt-seg-by-exper
longest_seg_exper_mode_reg_summ %>% select(strain:n, starts_with("shift_x")) %>%
    kbl(table.attr = "class=\'summary-table\'", booktabs = TRUE) %>%
    kable_paper("hover", fixed_thead = T) %>%
    kable_styling(full_width = FALSE)
```
:::
:::::

::::: {layout-ncol="2"}
::: column
```{r}
#| label: fig-shift_x-lgt-mrg-by-exper
merged_seg_FoV_reg_to_plot <- left_join(merged_seg_FoV_reg, merged_seg_exper_mode_reg_summ,
                                            by = c("strain", "date", "mode", "addl_info")) %>%
                                mutate(exper = paste(strain, date, sep = ", ")) %>%
                                dplyr::filter(strain %in% strains_to_include)

print(create_histogram_plot_grid(merged_seg_FoV_reg_to_plot, "shift_x", c("exper", "mode"), x_limit_method = "minmax", num_cols = 2))
```
:::

::: column
```{r}
#| label: tbl-shift_x-mgr-seg-by-exper
merged_seg_exper_mode_reg_summ %>% select(strain:n, starts_with("shift_x")) %>%
    kbl(table.attr = "class=\'summary-table\'", booktabs = TRUE) %>%
    kable_paper("hover", fixed_thead = T) %>%
    kable_styling(full_width = FALSE)
```
:::
:::::

Plotting only those data points with $\bar{x}\pm2\sigma$

```{r}
#| label: fig-shift_x-mrg-seg-by-exper-2sig
create_histogram_plot_grid(dplyr::filter(longest_seg_FoV_reg_to_plot, between(shift_x, -2*shift_x_sd + shift_x_mean, shift_x_mean + 2*shift_x_sd)), "shift_x", c("exper", "mode"), x_limit_method = "minmax", num_cols = 2)
```

```{r}
create_histogram_plot_grid(dplyr::filter(merged_seg_FoV_reg_to_plot, between(shift_x, -2*shift_x_sd + shift_x_mean, shift_x_mean + 2*shift_x_sd)), "shift_x", c("exper", "mode"), x_limit_method = "minmax", num_cols = 2)
```

#### Shift Y

::::: {layout-ncol="2"}
::: column
```{r}
#| label: fig-shift_y-lgt-seg-by-exper
longest_seg_FoV_reg_to_plot <- left_join(longest_seg_FoV_reg, longest_seg_exper_mode_reg_summ,
                                            by = c("strain", "date", "mode", "addl_info")) %>%
                                mutate(exper = paste(strain, date, sep = ", ")) %>%
                                dplyr::filter(strain %in% strains_to_include)

print(create_histogram_plot_grid(longest_seg_FoV_reg_to_plot, "shift_y", c("exper", "mode"), x_limit_method = "minmax", num_cols = 2))
```
:::

::: column
```{r}
#| label: tbl-shift_y-lgt-seg-by-exper
longest_seg_exper_mode_reg_summ %>% select(strain:n, starts_with("shift_y")) %>%
    kbl(table.attr = "class=\'summary-table\'", booktabs = TRUE) %>%
    kable_paper("hover", fixed_thead = T) %>%
    kable_styling(full_width = FALSE)
```
:::
:::::

::::: {layout-ncol="2"}
::: column
```{r}
#| label: fig-shift_y-lgt-mrg-by-exper
merged_seg_FoV_reg_to_plot <- left_join(merged_seg_FoV_reg, merged_seg_exper_mode_reg_summ,
                                            by = c("strain", "date", "mode", "addl_info")) %>%
                                mutate(exper = paste(strain, date, sep = ", "))

print(create_histogram_plot_grid(merged_seg_FoV_reg_to_plot, "shift_y", c("exper", "mode"), x_limit_method = "minmax", num_cols = 2))
```
:::

::: column
```{r}
#| label: tbl-shift_y-mgr-seg-by-exper
merged_seg_exper_mode_reg_summ %>% select(strain:n, starts_with("shift_y")) %>%
    kbl(table.attr = "class=\'summary-table\'", booktabs = TRUE) %>%
    kable_paper("hover", fixed_thead = T) %>%
    kable_styling(full_width = FALSE)
```
:::
:::::

Plotting only those data points with $\bar{x}\pm2\sigma$

```{r}
#| label: fig-shift_y-lgt-seg-by-exper-2sig
print(create_histogram_plot_grid(dplyr::filter(longest_seg_FoV_reg_to_plot, between(shift_y, -2*shift_y_sd + shift_y_mean, shift_y_mean + 2*shift_y_sd)), "shift_y", c("exper", "mode"), x_limit_method = "minmax", num_cols = 2))
```

```{r}
#| label: fig-shift_y-mrg-seg-by-exper-2sig
print(create_histogram_plot_grid(dplyr::filter(merged_seg_FoV_reg_to_plot, between(shift_y, -2*shift_y_sd + shift_y_mean, shift_y_mean + 2*shift_y_sd)), "shift_y", c("exper", "mode"), x_limit_method = "minmax", num_cols = 2))
```

### Consider individual FoVs

```{r}
#| label: summ-stats-reg-ne-label
lgt_seg_ne_label_reg_summ <- longest_seg_ne_label_reg %>%
    group_by(strain, date, mode, addl_info, FoV_id) %>%
    calc_summ_stats(col_to_summ = c(scale, angle, shift_x, shift_y)) %>%
    ungroup() %>% rename(ne_count = n)

mrg_seg_ne_label_reg_summ <- merged_seg_ne_label_reg %>%
    group_by(strain, date, mode, addl_info, FoV_id) %>%
    calc_summ_stats(col_to_summ = c(scale, angle, shift_x, shift_y)) %>%
    ungroup() %>% rename(ne_count = n)

lgt_seg_ne_label_reg_to_plot <- left_join(longest_seg_ne_label_reg,
            lgt_seg_ne_label_reg_summ,
            by = c("strain", "date", "mode", "addl_info","FoV_id")) %>%
        mutate(exper = paste(strain, date, sep = ", ")) %>%
        dplyr::filter(strain %in% strains_to_include)

merged_seg_ne_label_reg_to_plot <- left_join(merged_seg_ne_label_reg,
            mrg_seg_ne_label_reg_summ,
            by = c("strain", "date", "mode", "addl_info","FoV_id")) %>%
        mutate(exper = paste(strain, date, sep = ", ")) %>%
        dplyr::filter(strain %in% strains_to_include)
```

```{r}
#| label: tbl-lgt-seg-ne-label-reg-summ
lgt_seg_ne_label_reg_summ %>%
    kbl(table.attr = "class=\'summary-table\'", booktabs = TRUE) %>%
    kable_paper("hover", fixed_thead = T) %>%
    kable_styling(full_width = FALSE)
```

```{r}
#| label: tbl-mrg-seg-ne-label-reg-summ
mrg_seg_ne_label_reg_summ %>%
    kbl(table.attr = "class=\'summary-table\'", booktabs = TRUE) %>%
    kable_paper("hover", fixed_thead = T) %>%
    kable_styling(full_width = FALSE)
```

```{r}

```

## Registration Precision

```{r}
reg_diff_join_by <- join_by(strain, date, FoV_id)

longest_seg_FoV_reg_diff <- left_join(longest_seg_FoV_reg %>%
                                            dplyr::filter(mode == "mode1") %>%
                                            dplyr::select(!mode),
                                        longest_seg_FoV_reg %>%
                                            dplyr::filter(mode == "mode2") %>%
                                            dplyr::select(!mode),
                                        suffix = c(".mode1", ".mode2"),
                                        by = reg_diff_join_by,
                                        relationship = "many-to-many"
                            ) %>%
                            mutate(
                                scale_diff = scale.mode1 - scale.mode2,
                                angle_diff = angle.mode1 - angle.mode2,
                                shift_y_diff = shift_y.mode1 - shift_y.mode2,
                                shift_x_diff = shift_x.mode1 - shift_x.mode2
                            ) %>%
                            dplyr::select(
                                strain, date, FoV_id, scale_diff, angle_diff, shift_y_diff, shift_x_diff
                            )

longest_seg_FoV_reg_diff <- left_join(all_experiment_key, longest_seg_FoV_reg_diff, by = reg_diff_join_by, relationship = "many-to-many")
```

NOTE: These calculations are done without outlier removal

```{r}
longest_seg_FoV_reg_diff_sum_stats <- longest_seg_FoV_reg_diff %>%
    group_by(strain, date, addl_info) %>%
    calc_summ_stats(col_to_summ = c(scale_diff, angle_diff, shift_x_diff, shift_y_diff)) %>%
    ungroup() %>%
        mutate(across(
        .cols = ends_with("_sd"),
        .fns = ~ 3.49 * .x * n**(-1/3),
        .names = "{str_remove(.col, '_sd')}_est_bin_width"))
```

```{r}
longest_seg_FoV_reg_precision <- longest_seg_FoV_reg_diff_sum_stats %>% mutate(reg_prec = sqrt(shift_x_diff_sd**2 + shift_y_diff_sd**2)) %>% select(strain,date,addl_info,n,shift_y_diff_sd,shift_x_diff_sd,reg_prec)

```

TODO: Plotting only those data points with $\bar{x}\pm2\sigma$



### Grouped By Experiment

Not grouped by mode as the comparison is between the modes

```{r}
#| label: tbl-lgt-set-reg-diff-summ
longest_seg_exper_reg_diff_summ <- longest_seg_FoV_reg_diff %>%
                                    group_by(strain, date) %>%
                                    calc_summ_stats(col_to_summ = c(scale_diff, angle_diff, shift_x_diff, shift_y_diff))

longest_seg_exper_reg_diff_summ %>%
    kbl() %>%
    kable_paper("hover") %>%
    scroll_box(width="100%")
```
