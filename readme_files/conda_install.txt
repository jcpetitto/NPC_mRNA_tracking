conda create -n yeast_env python=3.11

conda activate yeast_env

# TODO figure out if the uninstall and then reinstall this way is necessary / maybe don't do the initial installation of these packages??
conda uninstall pytorch torchvision pytorch-lightning segmentation-models-pytorch

conda install pytorch torchvision torchaudio pytorch-cuda=12.1 -c pytorch -c nvidia
conda install -c conda-forge pytorch-lightning segmentation-models-pytorch scikit-image scipy tifffile tqdm matplotlib networkx pytest imreg_dft


# Note: originally, pytest was installed AFTER theseus-ai  Need to confirm installing as above will work
# depending on the cluster, may need to install in parts (perhaps I should be in a job...?)
# !!! for interactive job not on a GPU
# bsub -Is -n 4 -W 4:00 -R "rusage[mem=32000]" bash
# TODO refer to yeast_env doc on drive re: installation reasoning when wrapping up the readme

conda activate yeast_env_new

conda install -c conda-forge theseus-ai




conda remove pytorch torchvision torchaudio pytorch-cuda -y


conda install pytorch=2.5.1 torchvision=0.20.1 torchaudio=2.5.1 pytorch-cuda=12.1 -c pytorch -c nvidia
conda install pytorch-lightning -c pytorch -c nvidia -c conda-forge
conda install segmentation-models-pytorch -c pytorch -c nvidia -c conda-forge


##### bsub -Is -q gpu -n 1 -W 02:00 -M 32000 -J -R /bin/bash



# Note: if end up using these, need to install them
conda install -c conda-forge napari pygraphviz


######
# TODO add to Readme
# Requires each directory already have all associated json files saved to a single folder.
# This can be done by running the python script: `dict_from_directory.py` where the directory containing folders for individual strains is the first parameter, then the strain names (if selecting a few from many) with the `--strains` option and the folder in which to save the resulting json files using the `--output_dir` option.

# For tracking experiments

python src_yeast_pipeline/tools/directory_to_dict.py /pi/david.grunwald-umw/data/yeast_data/mRNA_tracking/ \
--strains BMY820 BMY822 BMY823 \
--output_dir /home/jocelyn.tourtellotte-umw/yeast_output/tracking_experiments/

# For dual label

python src_yeast_pipeline/tools/directory_to_dict.py /pi/david.grunwald-umw/data/yeast_data/npc_dual_label/ \
--strains BMY1408 BMY1409 BMY1410 BMY1914 BMY1915 \
--output_dir /home/jocelyn.tourtellotte-umw/yeast_output/dual_label_experiments/

########
# TODO Include in ReadMe
# moving on to parallelizing
chmod + ./src_yeast_pipeline/src_shell_scripts/sub_pipeline_jobs.sh
./src_yeast_pipeline/src_shell_scripts/sub_pipeline_jobs.sh

##########


# after installing miniconda in the pi directory AND then using yml to create the environment in the folder conda_envs in the pi directory 
# bsub -Is -q gpu -gpu "" nvidia-smi

# bsub -Is -q gpu -n 1 -W 02:00 -M 32000 -J -R /bin/bash
# conda activate yeast_img_env

python ./src_yeast_pipeline/main_cluster.py


#### IMREG_DFT SAGA
# TODO include relevant part in the ReadMe
# NOTE re: imreg_dft; need to remove the conda install and install it via the github
conda activate yeast_img_env
conda remove imreg_dft
pip install --no-deps git+https://github.com/matejak/imreg_dft.git
pip show imreg_dft

######
        Collecting git+https://github.com/matejak/imreg_dft.git
        Cloning https://github.com/matejak/imreg_dft.git to /tmp/pip-req-build-ppic43ah
        Running command git clone --filter=blob:none --quiet https://github.com/matejak/imreg_dft.git /tmp/pip-req-build-ppic43ah
        Resolved https://github.com/matejak/imreg_dft.git to commit 4023e9e2c4110b04017c85e7bda9883a71b2eea0
        Preparing metadata (setup.py) ... done
        Building wheels for collected packages: imreg_dft
        DEPRECATION: Building 'imreg_dft' using the legacy setup.py bdist_wheel mechanism, which will be removed in a future version. pip 25.3 will enforce this behaviour change. A possible replacement is to use the standardized build interface by setting the `--use-pep517` option, (possibly combined with `--no-build-isolation`), or adding a `pyproject.toml` file to the source tree of 'imreg_dft'. Discussion can be found at https://github.com/pypa/pip/issues/6334
        Building wheel for imreg_dft (setup.py) ... done
        Created wheel for imreg_dft: filename=imreg_dft-2.0.1a0-py3-none-any.whl size=47743 sha256=f4e6001e388d970f26db9ef2fcad1804dcb3a5489fa6c23d80c1da4df9350929
        Stored in directory: /tmp/pip-ephem-wheel-cache-pel1k988/wheels/70/06/89/cc9434187769be5c05481c3a47d5f45a5bfb5625acac39d192
        Successfully built imreg_dft
        Installing collected packages: imreg_dft
        Successfully installed imreg_dft-2.0.1a0
#####


### /pi/david.grunwald-umw/conda_envs/yeast_img_env/lib/python3.11/site-packages/imreg_dft/


(yeast_env_new) [jocelyn.tourtellotte-umw@r640c18 ~]$ pip install --no-deps git+https://github.com/matejak/imreg_dft.git
Collecting git+https://github.com/matejak/imreg_dft.git
  Cloning https://github.com/matejak/imreg_dft.git to /tmp/pip-req-build-y9sgtytf
  Running command git clone --filter=blob:none --quiet https://github.com/matejak/imreg_dft.git /tmp/pip-req-build-y9sgtytf
  Resolved https://github.com/matejak/imreg_dft.git to commit 4023e9e2c4110b04017c85e7bda9883a71b2eea0
  Preparing metadata (setup.py) ... done
Building wheels for collected packages: imreg_dft
  DEPRECATION: Building 'imreg_dft' using the legacy setup.py bdist_wheel mechanism, which will be removed in a future version. pip 25.3 will enforce this behaviour change. A possible replacement is to use the standardized build interface by setting the `--use-pep517` option, (possibly combined with `--no-build-isolation`), or adding a `pyproject.toml` file to the source tree of 'imreg_dft'. Discussion can be found at https://github.com/pypa/pip/issues/6334
  Building wheel for imreg_dft (setup.py) ... done
  Created wheel for imreg_dft: filename=imreg_dft-2.0.1a0-py3-none-any.whl size=47743 sha256=a83361cd4a2b142ddfb2183ecb1e3436303b66311a820a3c2197d8cfa48d36e8
  Stored in directory: /tmp/pip-ephem-wheel-cache-aogve3we/wheels/70/06/89/cc9434187769be5c05481c3a47d5f45a5bfb5625acac39d192
Successfully built imreg_dft
Installing collected packages: imreg_dft
Successfully installed imreg_dft-2.0.1a0
(yeast_env_new) [jocelyn.tourtellotte-umw@r640c18 ~]$ 


(yeast_env_new) [jocelyn.tourtellotte-umw@r640c18 ~]$ cd /pi/david.grunwald-umw/conda_envs/yeast_img_env/lib/python3.11/site-packages/imreg_dft/
(yeast_env_new) [jocelyn.tourtellotte-umw@r640c18 imreg_dft]$ grep -rwn --include='*.py' "np.bool" .
(yeast_env_new) [jocelyn.tourtellotte-umw@r640c18 imreg_dft]$ grep -rwn --include='*.py' "bool" .
./imreg.py:491:        invert (bool): Whether to perform inverse transformation --- doesn't
./tiles.py:127:        get_unextended (bool): Whether to get the transformed subject
./utils.py:709:    mask = np.zeros_like(img, dtype=bool)
./utils.py:888:    clusters = np.zeros((num, num), bool)
(yeast_env_new) [jocelyn.tourtellotte-umw@r640c18 imreg_dft]$ 


Latest environment installation (2025-08-23)
# Note: update the prefix to reflect your file system.
conda env create -f /home/jocelyn.tourtellotte-umw/pyr_yeast_env.yml
conda activate pyr_yeast_env
pip install --no-deps git+https://github.com/matejak/imreg_dft.git

# because --no-deps flag cannot be specified in the yml file re: on file
# alternative is to include -pip .... re: github install and use
# PIP_NO_DEPS=1 conda env create -f /home/jocelyn.tourtellotte-umw/pyr_yeast_env.yml
# BUT this would not allow any future packages that require a pip install to have dependencies installed (which may be a plus, given prior resolution issues between using conda and then installing via pip on top)
# For more reading:
# https://stackoverflow.com/questions/68584223/pip-dependencies-of-dependencies-when-installed-from-conda-environment-yaml/71469865#71469865

# !!! for documentation:
# conda install for geomdl: https://anaconda.org/orbingol/geomdl



bsub -Is -n 4 -W 1:00 -R "rusage[mem=32000]" bash

chmod +x ./src_yeast_pipeline/src_shell_scripts/sub_pipeline_jobs.sh
./src_yeast_pipeline/src_shell_scripts/sub_pipeline_jobs.sh ./src_yeast_pipeline/config_cluster_dual_label.json



# 2025-09-12

bsub -Is -q gpu -n 4 -W 04:00 -M 32000 -J -R /bin/bash

# 2025-10-16

bsub -Is -n 4 -R "rusage[mem=10G]span[hosts=1]" /bin/bash

ml apptainer
apptainer build yeast_analysis.sif recipe_yeast.spec